# This is the configuration, I've put on the board.
# If you apply voltage to it, the green LED D! serves as status led2
# usually blinking with around 1 Hz. If you press button USER 1, it will
# toggle green led D2.
# To upload a new firmware, search for the "Fallback Hotspot" WiFi and
# log in with password "Z8zfajgxVvNw". It could take up to a minute for
# the fallack AP to be enabled when not able to connect to the "test"
# wifi network. So, if status is blinking, give it a minute to show up.
substitutions:
  name: "km271-for-friends"

esphome:
  name: "${name}"
  # Automatically add the mac address to the name
  # so you can use a single firmware for all devices
  name_add_mac_suffix: true

  # This will allow for (future) project identification,
  # configuration and updates.
  project:
    name: the78mole.km271-wifi
    version: "1.0"

esp32:
  board: esp32dev
  framework:
    type: arduino

# Enable logging
logger:

# Enable Home Assistant API
api:

ota:
#  password: "xxx"

wifi:
#  ssid: "test"
#  password: "testtest"

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Fallback Hotspot"
    password: "Z8zfajgxVvNw"

dashboard_import:
  package_import_url: github://the78mole/esphome_components/components/km271_wifi/km271-for-friends.yaml@main

captive_portal:
#  keep_user_credentials: true

uart:
  id: uart_bus
  tx_pin: GPIO2
  rx_pin: GPIO4
  baud_rate: 2400

external_components:
  - source: github://the78mole/esphome_components@main
    components: [ km271_wifi ]
#  - source:
#      type: local
#      path: my_components/components
#    components: [ km271_wifi ]
 
esp32_improv:
  authorizer: improvble
  authorized_duration: 120s
  status_indicator: led3
  identify_duration: 60s

improv_serial: 

km271_wifi:
  - id: budoil
    uart_id: uart_bus

status_led:
  id: ledgn1
  pin: 
    number: GPIO21
    inverted: true

button:
  - platform: restart
    name: "KM271-WiFi Restart"
  - platform: template
    name: "KM271 WW-Bereitung Aus"
    on_press:
      - lambda:
          uint8_t command[] = {0x0C, 0x0E, 0x00, 0x65, 0x65, 0x65, 0x65, 0x65};
          budoil->writer.enqueueTelegram(command, 8);
  - platform: template
    name: "KM271 WW-Bereitung Ein"
    on_press:
      - lambda:
          uint8_t command[] = {0x0C, 0x0E, 0x01, 0x65, 0x65, 0x65, 0x65, 0x65};
          budoil->writer.enqueueTelegram(command, 8);
  - platform: template
    name: "KM271 WW-Bereitung Auto"
    on_press:
      - lambda:
          uint8_t command[] = {0x0C, 0x0E, 0x02, 0x65, 0x65, 0x65, 0x65, 0x65};
          budoil->writer.enqueueTelegram(command, 8);


number:
  - platform: km271_wifi
    ww_temperature:
      name: "Warmwassersolltemperatur Tag"
      mode: slider

select:
  - platform: template
    name: "Warmwasser Betriebsart"
    id: warmwasser_betriebsart
    entity_category: config
    optimistic: true
    options:
      - Dauerhaft aus (0)
      - Dauerhaft ein (1)
      - Automatik (2)
    initial_option: Automatik (2)
    set_action: 
      - lambda:
          auto index = id(warmwasser_betriebsart).index_of(x);
          if (index.has_value()) {
            uint8_t command[] = {0x0C, 0x0E, (uint8_t)index.value(), 0x65, 0x65, 0x65, 0x65, 0x65};
            budoil->writer.enqueueTelegram(command, 8);
          }

binary_sensor:
  - platform: gpio
    id: improvble
    name: "USER 2"
    pin:
      number: GPIO27
      inverted: true
      mode:
        input: true
        pullup: true
  - platform: km271_wifi
    error_burner_malfunction:
      name: "KM271 Kesselfehler"
    error_additional_sensor:
      name: "KM271 Zusatzsensorfehler"
    error_boiler_sensor:
      name: "KM271 Sensorfehler"
    error_boiler_stays_cold:
      name: "KM271 Kessel bleibt kalt"
    error_safety_chain_released:
      name: "KM271 Sicherheitskette ausgelöst"
    error_external_disturbance:
      name: "KM271 Externer Fehler"
    alarm_boiler_flow_sensor:
      name: "KM271 Alarm Kesselflusssensor"
    alarm_burner:
      name: "KM271 Alarm Kessel"
    boiler_1st_stage_operation:
      name: "KM271 Kessel 1. Stufe"
    boiler_protection:
      name: "KM271 Kessel Schutz"
    boiler_under_operation:
      name: "KM271 Kessel in Betrieb"
    boiler_performance_free:
      name: "KM271 Kessel Leistung frei"
    boiler_performance_high:
      name: "KM271 Kessel Leistung hoch"
    boiler_2st_stage_operation:
      name: "KM271 Kessel 2. Stufe"
    boiler_actuation:
      name: "KM271 Kessel Ansteuerung"
    load_pump_running:
      name: "KM271 Ladepumpe"
    circulation_pump_running:
      name: "KM271 Zirkulationspumpenbetrieb"

sensor:
  - platform: km271_wifi
    heating_circuit_1_flow_target_temperature:
      name: "KM271 Vorlaufsolltemperatur"
    heating_circuit_1_flow_temperature:
      name: "KM271 Vorlauftemperatur"
    ww_target_temperature:
      name: "KM271 Warmwassersolltemperatur"
    ww_temperature:
      name: "KM271 Warmwassertemperatur"
    boiler_target_temperature:
      name: "KM271 Kesselvorlaufsolltemperatur"
    boiler_temperature:
      name: "KM271 Kesselvorlauftemperatur"
    outdoor_temperature:
      name: "KM271 Außentemperatur"
    heating_circuit_1_room_target_temperature:
      name: "KM271 Raumsolltemperatur"
    heating_circuit_1_curve_n10:
      name: "KM271 Heizkurve -10 °C"
    heating_circuit_1_curve_0:
      name: "KM271 Heizkurve 0 °C"
    heating_circuit_1_curve_p10:
      name: "KM271 Heizkurve +10 °C"
    boiler_turn_on_temperature:
      name: "KM271 Brennereinschalttemperatur"
    boiler_turn_off_temperature:
      name: "KM271 Brennerausschalttemperatur"
    boiler_runtime_1:
      name: "Brennerlaufzeit 1"
    boiler_runtime_2:
      name: "Brennerlaufzeit 2"


  - platform: wifi_signal
    name: "KM217 WiFi Signal Sensor"
    update_interval: 60s
      
switch:
  - platform: gpio
    name: LED2_Green
    pin: 
      number: 22
      mode: OUTPUT
      inverted: true

output:
  - platform: gpio
    id: led3
    #name: LED3_Yellow
    pin: 
      number: 23
      mode: OUTPUT
      inverted: true
  - platform: gpio
    id: led4
    #name: LED4_Red
    pin: 
      number: 25
      mode: OUTPUT
      inverted: true
